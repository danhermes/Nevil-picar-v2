#!/bin/bash
source ./nevil2env/bin/activate
source ~/Nevil-picar-v2/install/setup.bash

# Ensure PYTHON_EXECUTABLE is set to the virtualenv Python
if [[ -z "$PYTHON_EXECUTABLE" || "$PYTHON_EXECUTABLE" == "/usr/bin/python3" ]]; then
    export PYTHON_EXECUTABLE="$HOME/Nevil-picar-v2/nevil2env/bin/python"
fi

# Source ROS 2 and workspace setup if available
if [[ -f "$HOME/ros2_humble/install/setup.bash" ]]; then
    source "$HOME/ros2_humble/install/setup.bash"
fi

if [[ -f "$HOME/Nevil-picar-v2/install/setup.bash" ]]; then
    source "$HOME/Nevil-picar-v2/install/setup.bash"
fi

# Project root
PROJECT_DIR="$HOME/Nevil-picar-v2"

# Get absolute path to ros2 executable
ros2_cli=$(which ros2)

# Dispatch logic
if [[ "$1" == "launch" ]]; then
    shift
    if [[ -z "$1" ]]; then
        echo "? Error: No launch file specified."
        exit 1
    fi
    echo "? Launching with: $ros2_cli launch $@"
    "$ros2_cli" launch "$@"

elif [[ "$1" == "build" ]]; then
    shift
    echo "? Building with: colcon build $@"
    colcon build "$@"
    
    # Post-build: Apply wrapper script fixes for all packages
    apply_wrapper_fixes() {
        if [[ -d "src/wrapper_templates" ]]; then
            echo "? Applying wrapper script fixes..."
            local fixes_applied=0
            
            # Apply fixes for each package
            for package in nevil_bringup nevil_interfaces_ai nevil_core nevil_navigation nevil_realtime nevil_simulation; do
                if [[ -d "install/$package/lib/$package" ]]; then
                    # Copy wrapper scripts for this package
                    for template in src/wrapper_templates/*; do
                        if [[ -f "$template" && -x "$template" && "$template" != *".md" && "$template" != *"COLCON_IGNORE" ]]; then
                            template_name=$(basename "$template")
                            target_dir="install/$package/lib/$package"
                            
                            # Check if this wrapper belongs to this package (exists in install)
                            if [[ -f "$target_dir/$template_name" || -f "$target_dir/${template_name}.py" ]]; then
                                cp "$template" "$target_dir/" 2>/dev/null
                                chmod +x "$target_dir/$template_name" 2>/dev/null
                                fixes_applied=1
                            fi
                        fi
                    done
                fi
            done
            
            if [[ $fixes_applied -eq 1 ]]; then
                echo "? Wrapper scripts updated with correct library paths"
            fi
        fi
    }
    
    # Apply wrapper fixes for full builds or when specific packages are built
    apply_wrapper_fixes

else
    "$ros2_cli" "$@"
fi
